<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图像推荐系统演示</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
    <script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
  </head>
  <body>
    <main class="container">
      <header class="hero">
        <h1>图像推荐系统</h1>
        <p>
          上传图像或输入文本，系统将展示最相关的候选图像。点击候选图像可放大查看，开启调试模式后将同步显示文本描述。
        </p>
      </header>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert">
            {% for message in messages %}
              <p>{{ message }}</p>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <section class="panel">
        <h2>基于图像的检索</h2>
        <form method="post" enctype="multipart/form-data" class="form-grid">
          <input type="hidden" name="action" value="image" />
          <label class="field">
            <span>上传图片</span>
            <input type="file" name="image" accept="image/*" required />
          </label>
          <label class="field">
            <span>返回数量</span>
            <input type="number" name="top_k" min="1" max="50" value="{{ top_k }}" />
          </label>
          <label class="field field-switch">
            <input type="checkbox" name="debug" {% if debug_enabled %}checked{% endif %} />
            <span>开启调试模式</span>
          </label>
          <button type="submit" class="primary">开始检索</button>
        </form>
      </section>

      <section class="panel">
        <h2>基于文本的检索</h2>
        <form method="post" class="form-grid">
          <input type="hidden" name="action" value="text" />
          <label class="field">
            <span>文本描述</span>
            <input type="text" name="query" value="{{ query }}" placeholder="请输入检索关键词" required />
          </label>
          <label class="field">
            <span>返回数量</span>
            <input type="number" name="top_k" min="1" max="50" value="{{ top_k }}" />
          </label>
          <label class="field field-switch">
            <input type="checkbox" name="debug" {% if debug_enabled %}checked{% endif %} />
            <span>开启调试模式</span>
          </label>
          <button type="submit" class="primary">开始检索</button>
        </form>
      </section>

      {% if results %}
        <section class="panel">
          <header class="panel-header">
            <h2>推荐结果</h2>
            <div class="follow-settings">
              <form id="follow-form" method="post" class="follow-form">
                <input type="hidden" name="action" value="follow" />
                <input type="hidden" name="selected_image" id="follow-image-input" />
                <input type="hidden" name="debug" value="{% if debug_enabled %}on{% else %}off{% endif %}" />
                <label>
                  下一轮 Top K
                  <input
                    type="number"
                    name="top_k"
                    id="follow-topk-input"
                    value="{{ top_k }}"
                    min="1"
                    max="50"
                  />
                </label>
              </form>
            </div>
          </header>

          <div class="results-grid">
            {% for item in results %}
              <article class="result-card">
                <button
                  type="button"
                  class="preview"
                  data-role="preview"
                  data-url="{{ item.image_url }}"
                  data-description='{{ item.description | tojson | safe }}'
                  data-filename="{{ item.filename }}"
                >
                  <img src="{{ item.image_url }}" alt="{{ item.filename }}" loading="lazy" />
                </button>
                <footer class="card-footer">
                  <div class="meta">
                    <span class="filename" title="{{ item.source_path }}">{{ item.filename }}</span>
                    {% if item.score %}
                      <span class="score">相似度 {{ item.score }}</span>
                    {% endif %}
                  </div>
                  <button
                    type="button"
                    class="secondary next-round"
                    data-role="next-round"
                    data-source="{{ item.source_path }}"
                  >
                    使用此图继续检索
                  </button>
                </footer>
              </article>
            {% endfor %}
          </div>
        </section>
      {% endif %}
    </main>

    <section
      id="image-modal"
      class="modal"
      data-debug="{{ 'true' if debug_enabled else 'false' }}"
      aria-hidden="true"
    >
      <div class="modal-backdrop" data-role="close-modal"></div>
      <div class="modal-content">
        <button type="button" class="modal-close" data-role="close-modal" aria-label="关闭">×</button>
        <div class="modal-body">
          <img id="modal-image" alt="放大预览" />
          <aside id="modal-description" class="modal-description"></aside>
        </div>
        <div class="modal-caption">
          <span id="modal-filename"></span>
        </div>
      </div>
    </section>
  </body>
</html>
